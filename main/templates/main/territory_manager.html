{% extends 'main/base.html' %}
{% load static %}

{% block title %}Territory Manager - PMBeta{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/territory-manager.css' %}">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<div class="container-fluid territory-manager-app">
    {% csrf_token %}
    
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-primary">
                    <i class="fas fa-flag"></i> Territory Manager
                </h1>
                <div class="d-flex gap-2">
                    <button id="refresh-territories" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="place-territory-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-flag"></i> Place Territory
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="row">
        <!-- Map Area -->
        <div class="col-lg-8 col-md-7">
            <div class="card bg-dark text-white">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map"></i> Territory Map</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Map Container -->
                    <div id="map" style="height: 600px; position: relative;">
                        <!-- Loading overlay -->
                        <div id="map-loading" class="d-flex align-items-center justify-content-center position-absolute w-100 h-100" style="z-index: 1000; background: rgba(0,0,0,0.8);">
                            <div class="text-center text-white">
                                <div class="spinner-border" role="status"></div>
                                <p class="mt-2">Loading territories...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Map Controls Overlay -->
                    <div class="position-absolute" style="top: 10px; left: 10px; z-index: 200;">
                        <div class="bg-dark p-2 rounded">
                            <small class="text-white">
                                <strong>Zoom:</strong> <span id="current-zoom">15</span> |
                                <strong>Territories:</strong> <span id="territory-count">0</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4 col-md-5">
            <!-- Player Stats -->
            <div class="card bg-dark text-white mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user"></i> {{ character.name }}</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Level</small>
                            <div class="h5">{{ character.level }}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Gold</small>
                            <div class="h5" id="character-gold">{{ character.gold|floatformat:0 }}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Location</small>
                            <div class="small">{{ character.lat|floatformat:4 }}, {{ character.lon|floatformat:4 }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Economy Stats -->
            <div class="card bg-dark text-white mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-coins"></i> Economy Overview</h6>
                </div>
                <div class="card-body">
                    <div id="economy-stats">
                        <div class="stat-item">
                            <span class="stat-label">Territories:</span>
                            <span class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Revenue/Hour:</span>
                            <span class="stat-value">0 gold</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Upkeep/Day:</span>
                            <span class="stat-value">0 gold</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Net Profit/Day:</span>
                            <span class="stat-value">0 gold</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Territory Controls -->
            <div class="card bg-dark text-white mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-cogs"></i> Controls</h6>
                </div>
                <div class="card-body">
                    <!-- Emergency cleanup button -->
                    <button id="cleanup-phantom-flags" class="btn btn-danger btn-sm w-100 mb-3">
                        <i class="fas fa-broom"></i> Clean Phantom Flags
                    </button>
                    
                    <div class="control-row">
                        <span class="control-label">Auto-collect Revenue</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-collect-revenue" checked>
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">Auto-pay Upkeep</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-pay-upkeep">
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">Combat Alerts</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="combat-alerts" checked>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Territory List -->
            <div class="card bg-dark text-white">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-list"></i> My Territories</h6>
                    <button class="btn btn-sm btn-outline-light" id="collect-all-revenue">
                        <i class="fas fa-coins"></i> Collect All
                    </button>
                </div>
                <div class="card-body">
                    <div id="territory-list">
                        <p class="no-territories">Loading territories...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Territory Details Modal -->
    <div class="modal fade" id="territoryDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-flag"></i> <span id="modal-territory-name">Territory Details</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="territory-detail-content">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Basic Info</h6>
                                <table class="table table-sm table-dark">
                                    <tr><td>Owner:</td><td id="detail-owner">-</td></tr>
                                    <tr><td>Level:</td><td id="detail-level">-</td></tr>
                                    <tr><td>Status:</td><td id="detail-status">-</td></tr>
                                    <tr><td>HP:</td><td id="detail-hp">-</td></tr>
                                    <tr><td>Territory Range:</td><td id="detail-range">-</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Economy</h6>
                                <table class="table table-sm table-dark">
                                    <tr><td>Revenue/Hour:</td><td id="detail-revenue">-</td></tr>
                                    <tr><td>Daily Upkeep:</td><td id="detail-upkeep">-</td></tr>
                                    <tr><td>Uncollected:</td><td id="detail-uncollected">-</td></tr>
                                    <tr><td>Total Generated:</td><td id="detail-total-generated">-</td></tr>
                                    <tr><td>Upkeep Due:</td><td id="detail-upkeep-due">-</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Actions</h6>
                                <div class="btn-group w-100" role="group">
                                    <button id="collect-revenue-btn" class="btn btn-success">
                                        <i class="fas fa-coins"></i> Collect Revenue
                                    </button>
                                    <button id="pay-upkeep-btn" class="btn btn-warning">
                                        <i class="fas fa-credit-card"></i> Pay Upkeep
                                    </button>
                                    <button id="upgrade-btn" class="btn btn-info">
                                        <i class="fas fa-level-up-alt"></i> Upgrade
                                    </button>
                                    <button id="repair-btn" class="btn btn-secondary">
                                        <i class="fas fa-wrench"></i> Repair
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upgrade Preview -->
                        <div id="upgrade-preview" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6>Upgrade to Level <span id="upgrade-to-level"></span></h6>
                                <p class="mb-2">Cost: <span id="upgrade-cost"></span></p>
                                <p class="mb-2">Benefits:</p>
                                <ul class="mb-0">
                                    <li>Territory Range: <span id="upgrade-range"></span></li>
                                    <li>Max HP: <span id="upgrade-hp"></span></li>
                                    <li>Revenue Multiplier: <span id="upgrade-revenue"></span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="center-on-territory">
                        <i class="fas fa-crosshairs"></i> Center on Map
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Combat Modal -->
    <div class="modal fade" id="combatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white border-danger">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-sword"></i> Attack Territory
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="combat-target-info">
                        <h6 id="combat-target-name">Enemy Territory</h6>
                        <p class="text-muted" id="combat-target-details">Owner: Unknown | Level: 1 | HP: 100/100</p>
                    </div>
                    
                    <div class="damage-preview border border-danger rounded p-2 mb-3">
                        <small>
                            <strong>Attack Preview:</strong><br>
                            Damage: 20-30 HP<br>
                            Success Chance: 85%<br>
                            Cost: 5 Stamina
                        </small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Attacking will consume stamina and may trigger retaliation!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-attack">
                        <i class="fas fa-sword"></i> Attack!
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="position-fixed w-100 h-100 d-none" style="top: 0; left: 0; z-index: 9999; background: rgba(0,0,0,0.8);">
        <div class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center text-white">
                <div class="spinner-border mb-3" style="width: 3rem; height: 3rem;"></div>
                <h5>Processing...</h5>
                <p id="loading-message">Please wait...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- MapBox GL JS -->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<!-- Territory Manager -->
<script src="{% static 'js/territory-manager.js' %}"></script>

<script>
    // Initialize the territory management system
    document.addEventListener('DOMContentLoaded', function() {
        // Character data from Django context
        const character = {
            id: '{{ character.id }}',
            name: '{{ character.name }}',
            level: {{ character.level }},
            gold: {{ character.gold }},
            lat: {{ character.lat }},
            lon: {{ character.lon }}
        };
        
        // Initialize MapBox
        mapboxgl.accessToken = '{{ MAPBOX_ACCESS_TOKEN }}';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [character.lon, character.lat],
            zoom: 15,
            pitch: 0,
            bearing: 0
        });
        
        // Initialize Territory Manager
        let territoryManager;
        
        map.on('load', function() {
            // Hide loading overlay
            document.getElementById('map-loading').style.display = 'none';
            
            // Initialize territory manager
            territoryManager = new TerritoryManager({
                mapInstance: map,
                character: character
            });
            
            // Add player marker
            new mapboxgl.Marker({
                color: '#3498db',
                scale: 1.2
            })
            .setLngLat([character.lon, character.lat])
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(`<div style="text-align: center;">
                    <h4>${character.name}</h4>
                    <p>Level ${character.level}</p>
                    <p>You are here</p>
                </div>`))
            .addTo(map);
            
            // Update zoom display
            map.on('zoom', function() {
                document.getElementById('current-zoom').textContent = map.getZoom().toFixed(1);
            });
        });
        
        // Global territory manager reference
        window.territoryManager = territoryManager;
        
        // Additional UI handlers
        document.getElementById('collect-all-revenue').addEventListener('click', function() {
            if (territoryManager) {
                territoryManager.autoCollectAllRevenue();
            }
        });
        
        // Emergency cleanup button
        document.getElementById('cleanup-phantom-flags').addEventListener('click', function() {
            if (territoryManager) {
                console.log('🚑 User requested phantom flag cleanup');
                territoryManager.forceCleanPhantomFlags();
            }
        });
        
        // Territory details modal handlers
        const territoryDetailsModal = new bootstrap.Modal(document.getElementById('territoryDetailsModal'));
        const combatModal = new bootstrap.Modal(document.getElementById('combatModal'));
        
        // Add these to global scope for territory manager callbacks
        window.openTerritoryDetails = function(territoryId) {
            const territory = territoryManager.territories.get(territoryId);
            if (!territory) return;
            
            // Populate modal with territory data
            document.getElementById('modal-territory-name').textContent = territory.name;
            document.getElementById('detail-owner').textContent = territory.owner;
            document.getElementById('detail-level').textContent = territory.level;
            document.getElementById('detail-status').textContent = territory.status;
            document.getElementById('detail-hp').textContent = `${territory.current_hp || 0}/${territory.max_hp || 0}`;
            document.getElementById('detail-range').textContent = `${territory.radius_meters || 0}m`;
            
            // Economy stats (these would come from the API)
            document.getElementById('detail-revenue').textContent = `${territory.hourly_revenue || 0} gold/hour`;
            document.getElementById('detail-upkeep').textContent = `${territory.daily_upkeep_cost || 0} gold/day`;
            document.getElementById('detail-uncollected').textContent = `${territory.uncollected_revenue || 0} gold`;
            document.getElementById('detail-total-generated').textContent = `${territory.total_revenue_generated || 0} gold`;
            
            // Show modal
            territoryDetailsModal.show();
            
            // Store current territory ID for button actions
            territoryDetailsModal._element.dataset.territoryId = territoryId;
        };
        
        window.openCombatModal = function(territoryId) {
            const territory = territoryManager.territories.get(territoryId);
            if (!territory) return;
            
            document.getElementById('combat-target-name').textContent = territory.name;
            document.getElementById('combat-target-details').textContent = 
                `Owner: ${territory.owner} | Level: ${territory.level} | HP: ${territory.current_hp}/${territory.max_hp}`;
            
            combatModal.show();
            combatModal._element.dataset.territoryId = territoryId;
        };
        
        // Modal button handlers
        document.getElementById('collect-revenue-btn').addEventListener('click', function() {
            const territoryId = territoryDetailsModal._element.dataset.territoryId;
            if (territoryId && territoryManager) {
                territoryManager.collectRevenue(territoryId);
            }
        });
        
        document.getElementById('confirm-attack').addEventListener('click', function() {
            const territoryId = combatModal._element.dataset.territoryId;
            if (territoryId && territoryManager) {
                territoryManager.attackTerritory(territoryId);
                combatModal.hide();
            }
        });
        
        document.getElementById('center-on-territory').addEventListener('click', function() {
            const territoryId = territoryDetailsModal._element.dataset.territoryId;
            if (territoryId && territoryManager) {
                territoryManager.centerOnTerritory(territoryId);
                territoryDetailsModal.hide();
            }
        });
        
        // Loading overlay helper
        window.showLoading = function(message = 'Loading...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.remove('d-none');
        };
        
        window.hideLoading = function() {
            document.getElementById('loading-overlay').classList.add('d-none');
        };
    });
</script>
{% endblock %}
