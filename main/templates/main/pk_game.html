{% extends 'main/base.html' %}
{% load static %}

{% block title %}PMBeta - Parallel Kingdom Style{% endblock %}

{% block content %}
<div class="pk-game-container">
    {% csrf_token %}
    
    <!-- Top Bar -->
    <div class="pk-top-bar">
        <div class="pk-logo">
            <i class="fas fa-crown"></i> PMBeta
        </div>
        
        <div class="pk-character-info">
            <div class="pk-stat">
                <div class="pk-stat-label">Level</div>
                <div class="pk-stat-value" id="char-level">{{ character.level }}</div>
            </div>
            <div class="pk-stat">
                <div class="pk-stat-label">Gold</div>
                <div class="pk-stat-value" id="char-gold">{{ character.gold|floatformat:0 }}</div>
            </div>
            <div class="pk-stat">
                <div class="pk-stat-label">HP</div>
                <div class="pk-stat-value" id="char-hp">{{ character.current_hp }}/{{ character.max_hp }}</div>
            </div>
            <div class="pk-stat">
                <div class="pk-stat-label">Location</div>
                <div class="pk-stat-value" style="font-size: 10px;">
                    {{ character.lat|floatformat:3 }},{{ character.lon|floatformat:3 }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="pk-main-content">
        <!-- Sidebar Navigation -->
        <div class="pk-sidebar">
            <ul class="pk-nav-tabs">
                <li class="pk-nav-tab active" data-panel="world">
                    <a href="#world">
                        <i class="fas fa-globe"></i>
                        <span>World Map</span>
                    </a>
                </li>
                <li class="pk-nav-tab" data-panel="territories">
                    <a href="#territories">
                        <i class="fas fa-flag"></i>
                        <span>Territories</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Content Area -->
        <div class="pk-content-area">
            <!-- World Map Panel -->
            <div class="pk-content-panel active" id="panel-world">
                <div id="pk-map">
                    <div class="pk-loading" id="map-loading">
                        <div>
                            <div class="pk-spinner"></div>
                            <p style="margin-top: 20px;">Loading world map...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Territories Panel -->
            <div class="pk-content-panel" id="panel-territories">
                <div style="padding: 20px; text-align: center;">
                    <h3><i class="fas fa-flag"></i> Territories</h3>
                    <p style="color: #ccc;">Territory system temporarily disabled to fix phantom markers bug.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character data from Django context
    const character = {
        id: '{{ character.id }}',
        name: '{{ character.name }}',
        level: {{ character.level }},
        gold: {{ character.gold }},
        lat: {{ character.lat }},
        lon: {{ character.lon }}
    };
    
    // Initialize MapBox
    mapboxgl.accessToken = '{{ MAPBOX_ACCESS_TOKEN }}';
    
    let worldMap;
    
    // Navigation system
    const navTabs = document.querySelectorAll('.pk-nav-tab');
    const contentPanels = document.querySelectorAll('.pk-content-panel');
    
    navTabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const panelId = this.dataset.panel;
            switchPanel(panelId);
        });
    });
    
    function switchPanel(panelId) {
        // Update active tab
        navTabs.forEach(tab => tab.classList.remove('active'));
        document.querySelector([data-panel=""]).classList.add('active');
        
        // Update active panel
        contentPanels.forEach(panel => panel.classList.remove('active'));
        document.getElementById(panel-).classList.add('active');
        
        // Initialize panel content if needed
        if (panelId === 'world') {
            initWorldMap();
        }
    }
    
    function initWorldMap() {
        if (worldMap) return; // Already initialized
        
        worldMap = new mapboxgl.Map({
            container: 'pk-map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [character.lon, character.lat],
            zoom: 15,
            minZoom: 15,
            maxZoom: 18,
            pitch: 0,
            bearing: 0
        });
        
        worldMap.on('load', function() {
            document.getElementById('map-loading').style.display = 'none';
            
            // Add player marker
            new mapboxgl.Marker({
                color: '#3498db',
                scale: 1.2
            })
            .setLngLat([character.lon, character.lat])
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(<div style="text-align: center;">
                    <h4></h4>
                    <p>Level </p>
                    <p>You are here</p>
                </div>))
            .addTo(worldMap);
        });
    }
    
    // Initialize with world map
    switchPanel('world');
});
</script>
{% endblock %}
