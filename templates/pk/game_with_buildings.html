{% extends 'pk/base.html' %}

{% block title %}Parallel Kingdom - Game{% endblock %}

{% block extra_css %}
<style>
/* Context Menu Styles */
.context-menu {
    position: absolute;
    z-index: 10000;
    background: rgba(40, 44, 52, 0.95);
    border: 2px solid #2ecc71;
    border-radius: 8px;
    padding: 8px 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    min-width: 200px;
    display: none;
}

.context-menu-item {
    padding: 12px 20px;
    cursor: pointer;
    color: #ecf0f1;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.context-menu-item:hover {
    background: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
}

.context-menu-item:last-child {
    border-bottom: none;
}

.context-menu-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.context-menu-item.disabled:hover {
    background: transparent;
    color: #ecf0f1;
}

/* Building Placement Modal */
.building-modal .modal-content {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border: 2px solid #2ecc71;
    border-radius: 15px;
}

.building-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.building-card {
    background: rgba(52, 73, 94, 0.8);
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.building-card:hover {
    border-color: #2ecc71;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
}

.building-card.selected {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.2);
}

.building-card.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.flag-colors {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.flag-color {
    width: 30px;
    height: 30px;
    border: 2px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.2s;
}

.flag-color:hover {
    transform: scale(1.2);
}

.flag-color.selected {
    border-width: 4px;
    transform: scale(1.3);
}

/* Game Map Area */
.game-map {
    position: relative;
    background: linear-gradient(135deg, #1a252f 0%, #2c3e50 50%, #34495e 100%);
    border: 2px solid #2ecc71;
    border-radius: 15px;
    min-height: 500px;
    cursor: crosshair;
    overflow: hidden;
}

.building-marker {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #fff;
    transform: translate(-50%, -50%);
    cursor: pointer;
    transition: all 0.2s;
    z-index: 100;
}

.building-marker:hover {
    transform: translate(-50%, -50%) scale(1.5);
}

.building-marker.own {
    border-color: #2ecc71;
}

.building-marker.other {
    border-color: #e74c3c;
}

.player-marker {
    position: absolute;
    width: 15px;
    height: 15px;
    background: #f39c12;
    border: 3px solid #fff;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    z-index: 200;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(243, 156, 18, 0); }
    100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
}

/* Status Panels */
.status-panel {
    background: rgba(40, 44, 52, 0.9);
    border: 2px solid #2ecc71;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.resource-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 5px 0;
}

.resource-icon {
    color: #f39c12;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Status Bar -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="status-panel">
                <div class="row">
                    <div class="col-md-3">
                        <h5><i class="fas fa-user text-warning"></i> <span id="player-name">Loading...</span></h5>
                        <small class="text-muted">Level <span id="player-level">1</span></small>
                    </div>
                    <div class="col-md-3">
                        <div class="resource-bar">
                            <span><i class="fas fa-coins resource-icon"></i> Gold:</span>
                            <strong id="player-gold">0</strong>
                        </div>
                        <div class="resource-bar">
                            <span><i class="fas fa-tree resource-icon"></i> Wood:</span>
                            <strong id="player-wood">0</strong>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="resource-bar">
                            <span><i class="fas fa-mountain resource-icon"></i> Stone:</span>
                            <strong id="player-stone">0</strong>
                        </div>
                        <div class="resource-bar">
                            <span><i class="fas fa-building resource-icon"></i> Buildings:</span>
                            <strong id="player-buildings">0</strong>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button id="refresh-btn" class="btn pk-btn btn-sm">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="collect-all-btn" class="btn btn-success btn-sm ms-2">
                            <i class="fas fa-dollar-sign"></i> Collect All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Map -->
    <div class="row">
        <div class="col-md-9">
            <div class="game-map" id="game-map">
                <div class="text-center mt-5 pt-5">
                    <h4><i class="fas fa-map text-warning"></i> Game World</h4>
                    <p class="text-muted">Right-click anywhere to place a building</p>
                    <p class="text-muted">Click on buildings to interact</p>
                </div>
                <!-- Buildings and player marker will be added dynamically -->
            </div>
        </div>
        
        <div class="col-md-3">
            <!-- Nearby Buildings -->
            <div class="status-panel">
                <h6><i class="fas fa-building"></i> Nearby Buildings</h6>
                <div id="nearby-buildings" style="max-height: 300px; overflow-y: auto;">
                    <small class="text-muted">Loading...</small>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="status-panel">
                <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
                <button class="btn pk-btn btn-sm w-100 mb-2" onclick="showBuildingModal()">
                    <i class="fas fa-hammer"></i> Build
                </button>
                <button class="btn pk-btn btn-sm w-100 mb-2" onclick="centerOnPlayer()">
                    <i class="fas fa-crosshairs"></i> Center on Me
                </button>
                <button class="btn btn-outline-warning btn-sm w-100" onclick="loadGameData()">
                    <i class="fas fa-eye"></i> Scan Area
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu" class="context-menu">
    <div class="context-menu-item" onclick="showBuildingModal()">
        <i class="fas fa-hammer"></i>
        <span>Place Building</span>
    </div>
    <div class="context-menu-item" onclick="centerOnPlayer()">
        <i class="fas fa-crosshairs"></i>
        <span>Center on Me</span>
    </div>
    <div class="context-menu-item" onclick="scanArea()">
        <i class="fas fa-eye"></i>
        <span>Scan Area</span>
    </div>
</div>

<!-- Building Placement Modal -->
<div class="modal fade building-modal" id="building-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-hammer"></i> Place Building</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Building Name (Optional)</label>
                    <input type="text" class="form-control bg-dark text-light" id="building-name" placeholder="My Building">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Flag Color</label>
                    <div class="flag-colors" id="flag-colors">
                        <!-- Flag colors loaded dynamically -->
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Choose Building Type</label>
                    <div class="building-grid" id="building-grid">
                        <!-- Building types loaded dynamically -->
                    </div>
                </div>

                <div id="build-location" class="text-muted">
                    <i class="fas fa-map-marker-alt"></i> 
                    Location: <span id="build-coords">Click on map first</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn pk-btn" id="confirm-build" onclick="confirmBuildingPlacement()" disabled>
                    Build Now
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Game state
let gameState = {
    player: null,
    selectedBuildingType: null,
    selectedFlagColor: null,
    clickLocation: null,
    buildings: [],
    buildingTypes: [],
    flagColors: []
};

// Initialize game
document.addEventListener('DOMContentLoaded', function() {
    console.log('🏗️ Initializing Building Game...');
    setupEventHandlers();
    loadGameData();
    startGameLoop();
});

function setupEventHandlers() {
    // Context menu
    document.getElementById('game-map').addEventListener('contextmenu', handleRightClick);
    document.addEventListener('click', hideContextMenu);
    
    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', loadGameData);
    
    // Collect all button
    document.getElementById('collect-all-btn').addEventListener('click', collectAllRevenue);
}

function handleRightClick(e) {
    e.preventDefault();
    
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // Convert pixel coordinates to lat/lon (simplified)
    // In a real implementation, you'd use proper map projection
    const lat = gameState.player ? gameState.player.lat + (y - 250) / 10000 : 0;
    const lon = gameState.player ? gameState.player.lon + (x - 400) / 10000 : 0;
    
    gameState.clickLocation = { lat: lat, lon: lon, x: x, y: y };
    
    // Show context menu
    const contextMenu = document.getElementById('context-menu');
    contextMenu.style.left = e.clientX + 'px';
    contextMenu.style.top = e.clientY + 'px';
    contextMenu.style.display = 'block';
}

function hideContextMenu() {
    document.getElementById('context-menu').style.display = 'none';
}

function showBuildingModal() {
    hideContextMenu();
    
    if (!gameState.clickLocation) {
        alert('Right-click on the map first to select a location!');
        return;
    }
    
    // Update location display
    document.getElementById('build-coords').textContent = 
        `${gameState.clickLocation.lat.toFixed(6)}, ${gameState.clickLocation.lon.toFixed(6)}`;
    
    // Load building data if not loaded
    if (gameState.buildingTypes.length === 0) {
        loadBuildingTypes();
    }
    if (gameState.flagColors.length === 0) {
        loadFlagColors();
    }
    
    // Show modal
    new bootstrap.Modal(document.getElementById('building-modal')).show();
}

function loadBuildingTypes() {
    fetch('/api/building-types/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                gameState.buildingTypes = data.building_types;
                renderBuildingTypes();
            } else {
                console.error('Failed to load building types:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading building types:', error);
        });
}

function loadFlagColors() {
    fetch('/api/flag-colors/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                gameState.flagColors = data.flag_colors;
                renderFlagColors();
            } else {
                console.error('Failed to load flag colors:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading flag colors:', error);
        });
}

function renderBuildingTypes() {
    const grid = document.getElementById('building-grid');
    grid.innerHTML = '';
    
    gameState.buildingTypes.forEach(building => {
        const card = document.createElement('div');
        card.className = `building-card ${building.can_afford ? '' : 'disabled'}`;
        card.onclick = () => selectBuildingType(building);
        
        const categoryColor = {
            'economic': '#2ecc71',
            'military': '#e74c3c', 
            'utility': '#3498db',
            'decorative': '#9b59b6'
        }[building.category] || '#95a5a6';
        
        card.innerHTML = `
            <h6 style="color: ${categoryColor}">
                <i class="fas fa-${building.icon_name}"></i> ${building.name}
            </h6>
            <p class="small text-muted">${building.description}</p>
            <div class="small">
                <div><strong>Cost:</strong> ${building.cost.gold} gold, ${building.cost.wood} wood, ${building.cost.stone} stone</div>
                <div><strong>Revenue:</strong> ${building.revenue_per_hour} - ${building.max_revenue_per_hour} gold/hour</div>
                <div><strong>Build Time:</strong> ${building.construction_time_minutes} minutes</div>
            </div>
            ${!building.can_afford ? '<div class="text-danger small mt-2">Insufficient resources</div>' : ''}
        `;
        
        grid.appendChild(card);
    });
}

function renderFlagColors() {
    const container = document.getElementById('flag-colors');
    container.innerHTML = '';
    
    gameState.flagColors.forEach(color => {
        const colorDiv = document.createElement('div');
        colorDiv.className = 'flag-color';
        colorDiv.style.backgroundColor = color.hex_color;
        colorDiv.title = `${color.display_name}${color.is_premium ? ' (Premium)' : ''}`;
        
        if (color.can_use) {
            colorDiv.onclick = () => selectFlagColor(color);
        } else {
            colorDiv.style.opacity = '0.3';
            colorDiv.style.cursor = 'not-allowed';
        }
        
        container.appendChild(colorDiv);
    });
}

function selectBuildingType(building) {
    if (!building.can_afford) return;
    
    // Remove previous selection
    document.querySelectorAll('.building-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select this building
    event.target.closest('.building-card').classList.add('selected');
    gameState.selectedBuildingType = building;
    updateConfirmButton();
}

function selectFlagColor(color) {
    if (!color.can_use) return;
    
    // Remove previous selection
    document.querySelectorAll('.flag-color').forEach(flag => {
        flag.classList.remove('selected');
    });
    
    // Select this color
    event.target.classList.add('selected');
    gameState.selectedFlagColor = color;
}

function updateConfirmButton() {
    const button = document.getElementById('confirm-build');
    button.disabled = !gameState.selectedBuildingType;
}

function confirmBuildingPlacement() {
    if (!gameState.selectedBuildingType || !gameState.clickLocation) {
        alert('Please select a building type and location');
        return;
    }
    
    const buildingName = document.getElementById('building-name').value.trim();
    
    const buildData = {
        building_type_id: gameState.selectedBuildingType.id,
        lat: gameState.clickLocation.lat,
        lon: gameState.clickLocation.lon,
        flag_color_id: gameState.selectedFlagColor ? gameState.selectedFlagColor.id : null,
        custom_name: buildingName
    };
    
    fetch('/api/place-building/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(buildData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('building-modal')).hide();
            loadGameData(); // Refresh the game
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error placing building:', error);
        alert('Failed to place building');
    });
}

function loadGameData() {
    loadPlayerStatus();
    loadNearbyBuildings();
}

function loadPlayerStatus() {
    // This would need to be implemented based on your existing player API
    fetch('/api/player-status/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                gameState.player = data.player;
                updatePlayerDisplay();
            }
        })
        .catch(error => {
            console.error('Error loading player status:', error);
        });
}

function loadNearbyBuildings() {
    fetch('/api/nearby-buildings/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                gameState.buildings = data.buildings;
                renderBuildings();
                renderNearbyBuildingsList();
            }
        })
        .catch(error => {
            console.error('Error loading buildings:', error);
        });
}

function renderBuildings() {
    const map = document.getElementById('game-map');
    
    // Clear existing markers
    map.querySelectorAll('.building-marker, .player-marker').forEach(marker => {
        marker.remove();
    });
    
    // Add player marker
    if (gameState.player) {
        const playerMarker = document.createElement('div');
        playerMarker.className = 'player-marker';
        playerMarker.style.left = '50%'; // Center of map for now
        playerMarker.style.top = '50%';
        playerMarker.title = 'You are here';
        map.appendChild(playerMarker);
    }
    
    // Add building markers
    gameState.buildings.forEach(building => {
        const marker = document.createElement('div');
        marker.className = `building-marker ${building.is_own ? 'own' : 'other'}`;
        marker.style.backgroundColor = building.flag_color.hex_color;
        
        // Calculate position relative to player (simplified)
        const offsetX = (building.lon - (gameState.player?.lon || 0)) * 10000;
        const offsetY = (building.lat - (gameState.player?.lat || 0)) * 10000;
        
        marker.style.left = `calc(50% + ${offsetX}px)`;
        marker.style.top = `calc(50% - ${offsetY}px)`;
        
        marker.title = `${building.name} (${building.owner})`;
        marker.onclick = () => showBuildingInfo(building);
        
        map.appendChild(marker);
    });
}

function renderNearbyBuildingsList() {
    const container = document.getElementById('nearby-buildings');
    container.innerHTML = '';
    
    if (gameState.buildings.length === 0) {
        container.innerHTML = '<small class="text-muted">No nearby buildings</small>';
        return;
    }
    
    gameState.buildings.forEach(building => {
        const item = document.createElement('div');
        item.className = 'mb-2 p-2 bg-secondary rounded';
        item.style.cursor = 'pointer';
        item.onclick = () => showBuildingInfo(building);
        
        const statusColor = building.status === 'active' ? 'text-success' : 'text-warning';
        
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <strong>${building.name}</strong>
                <small class="${statusColor}">${building.status}</small>
            </div>
            <div class="small text-muted">
                ${building.type} - Level ${building.level}<br>
                ${building.revenue_per_hour} gold/hour<br>
                ${building.distance_meters}m away
            </div>
        `;
        
        container.appendChild(item);
    });
}

function showBuildingInfo(building) {
    alert(`${building.name}\nType: ${building.type}\nOwner: ${building.owner}\nLevel: ${building.level}\nRevenue: ${building.revenue_per_hour} gold/hour\nDistance: ${building.distance_meters}m`);
}

function collectAllRevenue() {
    const ownBuildings = gameState.buildings.filter(b => b.is_own);
    if (ownBuildings.length === 0) {
        alert('You have no buildings to collect from');
        return;
    }
    
    // Collect from each building
    let totalCollected = 0;
    let collectionsRemaining = ownBuildings.length;
    
    ownBuildings.forEach(building => {
        fetch(`/api/collect-revenue/${building.id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            collectionsRemaining--;
            if (data.success) {
                totalCollected += data.revenue_collected;
            }
            
            if (collectionsRemaining === 0) {
                if (totalCollected > 0) {
                    alert(`Collected ${totalCollected} total gold from all buildings!`);
                    loadGameData();
                } else {
                    alert('No revenue to collect from any buildings');
                }
            }
        });
    });
}

function updatePlayerDisplay() {
    if (!gameState.player) return;
    
    document.getElementById('player-name').textContent = gameState.player.name;
    document.getElementById('player-level').textContent = gameState.player.level;
    document.getElementById('player-gold').textContent = gameState.player.gold.toLocaleString();
    document.getElementById('player-buildings').textContent = gameState.buildings.filter(b => b.is_own).length;
    
    // Update resource counts from inventory
    document.getElementById('player-wood').textContent = gameState.player.wood || 0;
    document.getElementById('player-stone').textContent = gameState.player.stone || 0;
}

function centerOnPlayer() {
    hideContextMenu();
    if (!gameState.player) {
        alert('Player location not loaded');
        return;
    }
    
    // This would center the map view on the player
    console.log('Centering on player at:', gameState.player.lat, gameState.player.lon);
    alert(`Centered on your location: ${gameState.player.lat.toFixed(6)}, ${gameState.player.lon.toFixed(6)}`);
}

function scanArea() {
    hideContextMenu();
    loadGameData();
    alert('Area scanned for nearby buildings and resources!');
}

function startGameLoop() {
    // Refresh game data every 30 seconds
    setInterval(loadGameData, 30000);
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
